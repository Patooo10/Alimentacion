<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Alimentación Saludable — Single File (Avanzado)</title>
  <meta name="description" content="Planificador y monitor de hábitos alimenticios (HTML/CSS/JS - todo en un solo archivo)">
  <style>
    :root{--accent:#2b8aef;--bg:#f6f8fb;--card:#ffffff;--muted:#6b7280}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;background:var(--bg);margin:0;color:#0f172a}
    header{background:linear-gradient(90deg,#0ea5e9, #2563eb);color:white;padding:18px 20px;display:flex;align-items:center;justify-content:space-between}
    header h1{font-size:18px;margin:0}
    .container{max-width:1200px;margin:22px auto;padding:18px}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:18px}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
    h2{margin:0 0 12px 0;font-size:16px}
    label{font-size:13px;color:var(--muted)}
    input,select,textarea,button{font:inherit;padding:8px;border-radius:8px;border:1px solid #e6e9ef}
    textarea{min-height:60px}
    .meals-list{max-height:240px;overflow:auto}
    .meal-item{display:flex;justify-content:space-between;gap:12px;padding:8px;border-bottom:1px dashed #eef2f7}
    .small{font-size:13px;color:var(--muted)}
    .pill{background:#eef6ff;color:var(--accent);padding:6px 10px;border-radius:999px;font-weight:600}
    .progress{background:#eef2fb;border-radius:999px;height:12px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#7dd3fc)}
    .flex{display:flex;gap:10px;align-items:center}
    .stack{display:flex;flex-direction:column;gap:8px}
    .recipe{padding:8px;border-radius:8px;background:#f8fafc'}
    .muted{color:var(--muted)}
    .btn{background:var(--accent);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn.secondary{background:transparent;color:var(--accent);border:1px solid rgba(11,84,160,0.12)}
    .btn.ghost{background:transparent;border:none;color:var(--muted);padding:6px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:left}
    aside{display:block}
    footer{max-width:1200px;margin:0 auto;text-align:center;color:var(--muted);padding:12px}
    .login-overlay{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(15,23,42,0.45);display:flex;align-items:center;justify-content:center;z-index:9999}
    .login-box{background:white;padding:20px;border-radius:12px;max-width:420px;width:100%;box-shadow:0 10px 30px rgba(2,6,23,0.4)}
    .hidden{display:none}
    .doctor-panel{padding:14px}
    .list-item{padding:8px;border-radius:8px;background:#f8fafc;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
    .presc{padding:8px;border-radius:8px;background:#fff7ed;margin-bottom:8px;border:1px solid #fde3bf}
    @media (max-width:980px){.grid{grid-template-columns:1fr}.container{padding:12px}}
  </style>
</head>
<body>
  <!-- Login overlay -->
  <div id="loginOverlay" class="login-overlay" aria-hidden="false">
    <div class="login-box" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
      <h2 id="loginTitle">Iniciar sesión</h2>
      <p class="small muted">Usa: doctor / 1234  —  paciente / abcd</p>
      <div style="display:grid;gap:8px;margin-top:8px">
        <label>Usuario</label>
        <input id="loginUser" placeholder="usuario" />
        <label>Contraseña</label>
        <input id="loginPass" placeholder="contraseña" type="password" />
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
          <button class="btn" id="btnLogin">Entrar</button>
          <button class="btn secondary" id="btnDemo">Entrar como demo paciente</button>
        </div>
        <div id="loginMsg" class="small" style="color:#8b0000;display:none"></div>
      </div>
    </div>
  </div>

  <header>
    <h1>NutriPlan — Planificador Avanzado</h1>
    <div class="flex">
      <span class="small" id="currentUserDisplay">Archivo único · HTML/CSS/JS</span>
      <button id="btnLogout" class="btn secondary hidden" style="margin-left:10px">Cerrar sesión</button>
    </div>
  </header>

  <div class="container" id="mainApp">
    <div class="grid">
      <main id="patientArea">
        <section class="card">
          <h2>Registrar comida</h2>
          <form id="mealForm">
            <div class="stack">
              <label>Nombre de la comida</label>
              <input id="mealName" placeholder="Ej: Ensalada César" required />
              <label>Ingredientes (separados por coma)</label>
              <input id="mealIngredients" placeholder="Lechuga, pollo, queso, aderezo" />
              <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
                <div><label>Calorías (kcal)</label><input id="mealCalories" type="number" min="0" step="1" value="400" required /></div>
                <div><label>Proteínas (g)</label><input id="mealProtein" type="number" min="0" step="0.1" value="25" required /></div>
                <div><label>Carbohidratos (g)</label><input id="mealCarbs" type="number" min="0" step="0.1" value="40" required /></div>
                <div><label>Grasas (g)</label><input id="mealFat" type="number" min="0" step="0.1" value="12" required /></div>
              </div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button class="btn" type="submit">Registrar</button>
                <button class="btn secondary" type="button" id="btnClear">Limpiar</button>
                <button class="btn secondary" type="button" id="btnImport">Importar JSON</button>
              </div>
            </div>
          </form>

          <hr style="margin:12px 0" />

          <h2>Comidas de hoy <span id="todayDate" class="small muted"></span></h2>
          <div class="meals-list card" id="mealsList" style="padding:8px;">
          </div>
        </section>

        <section class="card" style="margin-top:12px">
          <h2>Planificador semanal avanzado</h2>
          <div class="stack">
            <label>Meta calórica diaria</label>
            <input id="goalCalories" type="number" value="2000" />
            <label>Macros objetivo (g)</label>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
              <input id="goalProtein" type="number" value="120" placeholder="Proteínas (g)" />
              <input id="goalCarbs" type="number" value="220" placeholder="Carbs (g)" />
              <input id="goalFat" type="number" value="70" placeholder="Grasas (g)" />
            </div>
            <label>Distribución por comidas (suma 100%)</label>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
              <input id="splitBreakfast" type="number" value="25" />
              <input id="splitLunch" type="number" value="30" />
              <input id="splitDinner" type="number" value="30" />
              <input id="splitSnack" type="number" value="15" />
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn" id="btnGenerateWeek">Generar plan semanal</button>
              <button class="btn secondary" id="btnApplyWeek">Aplicar plan a calendario</button>
              <button class="btn secondary" id="btnClearWeek">Limpiar semana</button>
            </div>
            <div id="weekResult" class="small muted" style="margin-top:8px;overflow:auto;max-height:260px"></div>
          </div>
        </section>

        <section class="card" style="margin-top:12px">
          <h2>Semana actual</h2>
          <div id="weekTable" style="overflow:auto"></div>
        </section>

      </main>

      <aside>
        <div class="card" style="margin-bottom:12px">
          <h2>Resumen diario</h2>
          <div class="stack">
            <div class="flex" style="justify-content:space-between"><div class="small">Calorías</div><div id="sumCalories" class="pill">0 kcal</div></div>
            <div class="small">Meta diaria (kcal)</div>
            <div class="progress" aria-hidden="true"><i id="progressCalories" style="width:0%"></i></div>

            <div style="display:flex;gap:8px;justify-content:space-between;margin-top:8px">
              <div class="small">Proteínas</div><div id="sumProtein" class="small">0 g</div>
            </div>
            <div style="display:flex;gap:8px;justify-content:space-between;">
              <div class="small">Carbs</div><div id="sumCarbs" class="small">0 g</div>
            </div>
            <div style="display:flex;gap:8px;justify-content:space-between;">
              <div class="small">Grasas</div><div id="sumFat" class="small">0 g</div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-bottom:12px">
          <h2>Recetas y búsqueda</h2>
          <input id="searchRecipe" placeholder="Buscar receta..." />
          <div id="recipes" style="margin-top:8px"></div>
        </div>

        <div class="card">
          <h2>Herramientas</h2>
          <div class="flex" style="justify-content:space-between">
            <div>
              <button class="btn" id="btnExport">Exportar datos (JSON)</button>
              <button class="btn secondary" id="btnReset">Resetear datos</button>
            </div>
            <div class="muted small">Guardado local con <strong>localStorage</strong>. Puedes descargar tu archivo de la semana actual.</div>
          </div>
        </div>
      </aside>
    </div>

    <footer>
      Creado con ❤️ — Crea habitos Saludables, no Restricciones.
    </footer>
  </div>

  <!-- Doctor panel (hidden by default) -->
  <div id="doctorPanel" class="card hidden" style="max-width:1100px;margin:22px auto;">
    <div class="doctor-panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Panel del Nutriólogo</h2>
        <div class="small muted">Sesión como <strong id="docUserLabel"></strong></div>
      </div>
      <hr />
      <div style="display:grid;grid-template-columns:300px 1fr;gap:12px">
        <div>
          <h3>Pacientes</h3>
          <div id="patientsList"></div>
        </div>
        <div>
          <h3>Prescripciones / Notas</h3>
          <div id="prescArea">
            <div id="prescList"></div>
            <hr />
            <h4>Añadir prescripción</h4>
            <label>Título</label>
            <input id="prescTitle" placeholder="Ej: Control de sodio" />
            <label>Descripción</label>
            <textarea id="prescText" placeholder="Indica recomendaciones, dosis, observaciones..."></textarea>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn" id="btnAddPresc">Guardar prescripción</button>
              <button class="btn secondary" id="btnClearPrescForm">Limpiar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /*************
     AUTH + DOCTOR PRESCRIPTIONS
     - Opción A: credenciales simples en local (sin backend)
     - doctor / 1234
     - paciente / abcd
     *************/
    const AUTH_KEY = 'nutriplan_auth_v1'; // guarda sesión {user, role}
    const PRESC_KEY = 'nutriplan_prescriptions_v1'; // estructura: { pacienteUser: [ {id, title, text, date, doctor} ] }

    const DEFAULT_USERS = [
      {user:'doctor', pass:'1234', role:'doctor', name:'Nutriólogo'},
      {user:'paciente', pass:'abcd', role:'patient', name:'Paciente Demo'}
    ];

    // helper localStorage for prescriptions
    function loadPrescriptions(){
      try{ const raw = localStorage.getItem(PRESC_KEY); return raw ? JSON.parse(raw) : {}; }catch(e){console.error(e); return {}; }
    }
    function savePrescriptions(obj){ localStorage.setItem(PRESC_KEY, JSON.stringify(obj)); }

    // session helpers
    function saveSession(sess){ localStorage.setItem(AUTH_KEY, JSON.stringify(sess)); }
    function loadSession(){ try{ const raw = localStorage.getItem(AUTH_KEY); return raw ? JSON.parse(raw) : null; }catch(e){return null;} }
    function clearSession(){ localStorage.removeItem(AUTH_KEY); }

    // UI elements
    const loginOverlay = document.getElementById('loginOverlay');
    const btnLogin = document.getElementById('btnLogin');
    const btnDemo = document.getElementById('btnDemo');
    const loginUser = document.getElementById('loginUser');
    const loginPass = document.getElementById('loginPass');
    const loginMsg = document.getElementById('loginMsg');
    const mainApp = document.getElementById('mainApp');
    const doctorPanel = document.getElementById('doctorPanel');
    const currentUserDisplay = document.getElementById('currentUserDisplay');
    const btnLogout = document.getElementById('btnLogout');
    const docUserLabel = document.getElementById('docUserLabel');

    // patients list for doctor - for now, only 'paciente' exists, but doctor can create entries manually
    function getKnownPatients(){
      // derive from existing prescriptions keys + default paciente
      const presc = loadPrescriptions();
      const keys = Object.keys(presc);
      const set = new Set(keys);
      set.add('paciente'); // ensure demo paciente exists
      return Array.from(set);
    }

    function showLoginOverlay(show){
      loginOverlay.style.display = show ? 'flex' : 'none';
      loginOverlay.setAttribute('aria-hidden', show ? 'false' : 'true');
    }

    function showPatientArea(show){
      document.getElementById('patientArea').style.display = show ? '' : 'none';
      // also hide or show aside and footer if desired (we keep container visible but hide doctor or patient parts)
    }

    function showDoctorPanel(show){
      doctorPanel.classList.toggle('hidden', !show);
    }

    function updateUIForSession(sess){
      if(!sess){
        // no session -> require login
        showLoginOverlay(true);
        currentUserDisplay.textContent = 'Archivo único · HTML/CSS/JS';
        btnLogout.classList.add('hidden');
        showDoctorPanel(false);
        showPatientArea(false);
      } else {
        showLoginOverlay(false);
        btnLogout.classList.remove('hidden');
        currentUserDisplay.textContent = `Conectado: ${sess.user} (${sess.role})`;
        if(sess.role === 'patient'){
          // show original patient UI (unchanged)
          showPatientArea(true);
          showDoctorPanel(false);
        } else if(sess.role === 'doctor'){
          // hide patient UI and show doctor panel
          showPatientArea(false);
          showDoctorPanel(true);
          docUserLabel.textContent = sess.user;
          renderPatientsList();
          // pre-select first patient
          const known = getKnownPatients();
          if(known.length>0) selectPatient(known[0]);
        }
      }
    }

    // attempt auto-login from session
    const existingSession = loadSession();
    if(existingSession){
      updateUIForSession(existingSession);
    } else {
      showLoginOverlay(true);
    }

    function authenticate(user, pass){
      const found = DEFAULT_USERS.find(u=>u.user === user && u.pass === pass);
      return found ? {user: found.user, role: found.role, name: found.name} : null;
    }

    btnLogin.addEventListener('click', ()=>{
      const u = loginUser.value.trim();
      const p = loginPass.value;
      const sess = authenticate(u,p);
      if(!sess){
        loginMsg.style.display = 'block'; loginMsg.textContent = 'Usuario o contraseña incorrectos.';
        return;
      }
      saveSession(sess);
      loginMsg.style.display = 'none';
      loginUser.value=''; loginPass.value='';
      updateUIForSession(sess);
      // render patient data if patient logged
      if(sess.role === 'patient'){
        // keep behavior original: render today's meals as before
        try{ renderMeals((new Date()).toISOString().slice(0,10)); renderWeekTable(); }catch(e){}
      }
    });

    btnDemo.addEventListener('click', ()=>{
      const sess = authenticate('paciente','abcd');
      saveSession(sess);
      updateUIForSession(sess);
      try{ renderMeals((new Date()).toISOString().slice(0,10)); renderWeekTable(); }catch(e){}
    });

    btnLogout.addEventListener('click', ()=>{
      clearSession();
      updateUIForSession(null);
      // show login overlay
      showLoginOverlay(true);
    });

    /*************
     Doctor panel: pacientes + prescripciones
     *************/
    const patientsListDiv = document.getElementById('patientsList');
    const prescListDiv = document.getElementById('prescList');
    const prescTitle = document.getElementById('prescTitle');
    const prescText = document.getElementById('prescText');
    const btnAddPresc = document.getElementById('btnAddPresc');
    const btnClearPrescForm = document.getElementById('btnClearPrescForm');

    let selectedPatient = null;

    function renderPatientsList(){
      const pts = getKnownPatients();
      patientsListDiv.innerHTML = '';
      pts.forEach(p=>{
        const div = document.createElement('div'); div.className='list-item';
        div.innerHTML = `<div style="font-weight:600">${p}</div><div><button class="btn secondary" data-p="${p}" onclick="selectPatient('${p}')">Ver</button></div>`;
        patientsListDiv.appendChild(div);
      });
      // allow adding a new patient quick
      const addDiv = document.createElement('div'); addDiv.style.marginTop='8px';
      addDiv.innerHTML = `<input id="newPatientInput" placeholder="Nuevo paciente (usuario)" style="width:60%;margin-right:6px" /><button class="btn" id="btnAddPatient">Añadir paciente</button>`;
      patientsListDiv.appendChild(addDiv);
      document.getElementById('btnAddPatient').addEventListener('click', ()=>{
        const inp = document.getElementById('newPatientInput'); const val = inp.value.trim();
        if(!val) return alert('Ingresa un nombre de paciente');
        const presc = loadPrescriptions(); if(!presc[val]) presc[val]=[]; savePrescriptions(presc);
        renderPatientsList();
        inp.value='';
      });
    }

    // expose selectPatient globally so inline handlers work
    window.selectPatient = function(user){
      selectedPatient = user;
      renderPatientPrescriptions(user);
    }

    function renderPatientPrescriptions(user){
      prescListDiv.innerHTML = `<div class="small muted">Prescripciones para <strong>${user}</strong></div><div style="height:8px"></div>`;
      const presc = loadPrescriptions();
      const arr = presc[user] || [];
      if(arr.length===0) prescListDiv.innerHTML += '<div class="small muted">No hay prescripciones</div>';
      arr.slice().reverse().forEach(item=>{
        const d = document.createElement('div'); d.className='presc';
        d.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${escapeHtml(item.title)}</strong><div class="small muted">${new Date(item.date).toLocaleString()} — por ${escapeHtml(item.doctor)}</div></div>
          <div style="display:flex;gap:6px"><button class="btn secondary" data-id="${item.id}" data-user="${user}" onclick="editPresc(this)">Editar</button><button class="btn secondary" data-id="${item.id}" data-user="${user}" onclick="deletePresc(this)">Eliminar</button></div></div>
          <div style="margin-top:8px">${escapeHtml(item.text).replace(/\n/g,'<br>')}</div>`;
        prescListDiv.appendChild(d);
      });
      // ensure simple focus
      docUserLabel.textContent = loadSession()?.user || 'doctor';
    }

    // add presc
    btnAddPresc.addEventListener('click', ()=>{
      if(!selectedPatient) return alert('Selecciona primero un paciente a la derecha.');
      const title = prescTitle.value.trim() || 'Sin título';
      const text = prescText.value.trim() || '';
      const presc = loadPrescriptions();
      const arr = presc[selectedPatient] || [];
      const id = 'p_' + Date.now() + '_' + Math.floor(Math.random()*9999);
      const sess = loadSession();
      arr.push({id, title, text, date: new Date().toISOString(), doctor: sess ? sess.user : 'doctor'});
      presc[selectedPatient] = arr;
      savePrescriptions(presc);
      prescTitle.value=''; prescText.value='';
      renderPatientPrescriptions(selectedPatient);
      alert('Prescripción guardada para ' + selectedPatient);
    });

    btnClearPrescForm.addEventListener('click', ()=>{ prescTitle.value=''; prescText.value=''; });

    // edit / delete handlers (exposed)
    window.editPresc = function(btn){
      const id = btn.dataset.id; const user = btn.dataset.user;
      const presc = loadPrescriptions();
      const arr = presc[user] || [];
      const item = arr.find(x=>x.id===id);
      if(!item) return alert('No encontrado');
      const newTitle = prompt('Editar título:', item.title); if(newTitle===null) return;
      const newText = prompt('Editar texto:', item.text); if(newText===null) return;
      item.title = newTitle; item.text = newText; item.date = new Date().toISOString();
      savePrescriptions(presc);
      renderPatientPrescriptions(user);
    }

    window.deletePresc = function(btn){
      const id = btn.dataset.id; const user = btn.dataset.user;
      if(!confirm('Eliminar prescripción?')) return;
      const presc = loadPrescriptions();
      presc[user] = (presc[user]||[]).filter(x=>x.id!==id);
      savePrescriptions(presc);
      renderPatientPrescriptions(user);
    }

    /*************
     END AUTH + DOCTOR
     *************/

    /* ------------------------------------------------------------------
       A continuación está **TU CÓDIGO ORIGINAL** tal cual — lo dejé intacto.
       Sólo agregué la lógica de arriba para login y panel doctor.
       (El código original comienza aquí)
    ------------------------------------------------------------------ */

    const STORAGE_KEY = 'nutriplan_data_v2';
    const todayStr = (new Date()).toISOString().slice(0,10);
    document.getElementById('todayDate').textContent = todayStr;

    // estado: ahora soporta meals por fecha con comidas por turno
    let state = {meals:{}}; // { '2025-11-14': {breakfast:[], lunch:[], dinner:[], snack:[] } }

    const RECIPES = [
      {id:1,name:'Ensalada César con pollo',cal:420,protein:30,carbs:25,fat:18,ingredients:['lechuga','pollo','queso','aderezo']},
      {id:2,name:'Tazón de quinoa y verduras',cal:520,protein:18,carbs:72,fat:14,ingredients:['quinoa','pimiento','brócoli','zanahoria']},
      {id:3,name:'Salmón a la plancha con espárragos',cal:480,protein:36,carbs:6,fat:32,ingredients:['salmon','esparragos','limon']},
      {id:4,name:'Tostada de aguacate y huevo',cal:350,protein:14,carbs:30,fat:18,ingredients:['pan','aguacate','huevo']},
      {id:5,name:'Bowl proteico (pollo, arroz integral, verduras)',cal:610,protein:45,carbs:60,fat:16,ingredients:['pollo','arroz integral','brocoli']},
      {id:6,name:'Batido proteico (frutas y proteína)',cal:300,protein:25,carbs:32,fat:4,ingredients:['leche','proteina','fruta']},
      {id:7,name:'Omelette de claras con espinacas',cal:220,protein:28,carbs:3,fat:10,ingredients:['huevo','claras','espinaca']}
    ];

    function loadState(){
      try{ const raw = localStorage.getItem(STORAGE_KEY); if(raw) state = JSON.parse(raw); }catch(e){console.error(e)}
    }
    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    loadState();

    // util
    function ensureDay(dateStr){ state.meals[dateStr] = state.meals[dateStr] || {breakfast:[], lunch:[], dinner:[], snack:[]} }
    ensureDay(todayStr);

    function totalsForDate(dateStr){ ensureDay(dateStr); const parts = ['breakfast','lunch','dinner','snack'];
      return parts.reduce((acc,part)=>{
        state.meals[dateStr][part].forEach(m=>{acc.cal+=Number(m.calories);acc.p+=Number(m.protein);acc.c+=Number(m.carbs);acc.f+=Number(m.fat)});
        return acc;
      },{cal:0,p:0,c:0,f:0});
    }

    // render comidas por turnos
    function renderMeals(dateStr){ ensureDay(dateStr);
      const container = document.getElementById('mealsList'); container.innerHTML='';
      const parts = ['breakfast','lunch','dinner','snack'];
      parts.forEach(part=>{
        const title = ({breakfast:'Desayuno',lunch:'Almuerzo',dinner:'Cena',snack:'Snack'})[part];
        const box = document.createElement('div'); box.className='card'; box.style.marginBottom='8px';
        const inner = document.createElement('div');
        inner.innerHTML = `<div style="display:flex;justify-content:space-between"><strong>${title}</strong><button class='btn secondary' data-day='${dateStr}' data-part='${part}' onclick='addManualMealPrompt(this)'>Añadir</button></div>`;
        const list = document.createElement('div'); list.style.marginTop='8px';
        const arr = state.meals[dateStr][part] || [];
        if(arr.length===0) list.innerHTML = '<div class="small muted">Sin comidas</div>';
        arr.forEach((m,idx)=>{
          const div = document.createElement('div'); div.className='meal-item';
          div.innerHTML = `<div><div style="font-weight:600">${escapeHtml(m.name)}</div><div class="small muted">${escapeHtml(m.ingredients||'--')}</div></div>
            <div style="text-align:right"><div class="small">${m.calories} kcal</div><div class="small muted">P:${m.protein}g C:${m.carbs}g F:${m.fat}g</div>
            <div style="margin-top:6px"><button class="btn secondary" data-day="${dateStr}" data-part="${part}" data-idx="${idx}" onclick="deleteMeal(this)">Eliminar</button></div></div>`;
          list.appendChild(div);
        });
        inner.appendChild(list); box.appendChild(inner); container.appendChild(box);
      });
      updateSummary(dateStr);
    }

    function escapeHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

    // form submit: default as 'lunch' for quick add
    document.getElementById('mealForm').addEventListener('submit', e=>{
      e.preventDefault(); const name = document.getElementById('mealName').value.trim();
      const ingredients = document.getElementById('mealIngredients').value.trim();
      const calories = Number(document.getElementById('mealCalories').value||0);
      const protein = Number(document.getElementById('mealProtein').value||0);
      const carbs = Number(document.getElementById('mealCarbs').value||0);
      const fat = Number(document.getElementById('mealFat').value||0);
      if(!name) return alert('Ingresa un nombre');
      ensureDay(todayStr);
      state.meals[todayStr].lunch.push({name,ingredients,calories,protein,carbs,fat,created:Date.now()});
      saveState(); renderMeals(todayStr); e.target.reset();
    });
    document.getElementById('btnClear').addEventListener('click', ()=>document.getElementById('mealForm').reset());

    window.deleteMeal = function(btn){ const day = btn.dataset.day; const part = btn.dataset.part; const idx = Number(btn.dataset.idx);
      if(!confirm('Eliminar esta comida?')) return; state.meals[day][part].splice(idx,1); saveState(); renderMeals(day);
    }

    window.addManualMealPrompt = function(btn){ const day = btn.dataset.day; const part = btn.dataset.part;
      const name = prompt('Nombre de la comida:'); if(!name) return; const cal = Number(prompt('Calorías (kcal):','300')||0);
      const prot = Number(prompt('Proteínas (g):','20')||0); const carbs = Number(prompt('Carbs (g):','30')||0); const fat = Number(prompt('Grasas (g):','10')||0);
      const ing = prompt('Ingredientes (coma):','')||''; state.meals[day][part].push({name,ingredients:ing,calories:cal,protein:prot,carbs:carbs,fat:fat,created:Date.now()}); saveState(); renderMeals(day);
    }

    // recetas
    const recipesContainer = document.getElementById('recipes');
    function renderRecipes(list){ recipesContainer.innerHTML=''; list.forEach(r=>{
      const d = document.createElement('div'); d.className='recipe'; d.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${escapeHtml(r.name)}</strong><div class="small muted">${r.cal} kcal · P:${r.protein}g</div></div><div style="text-align:right"><button class="btn" data-id="${r.id}" onclick="addRecipeToSlot(this)">Añadir</button></div></div><div class="small muted" style="margin-top:6px">Ingredientes: ${escapeHtml((r.ingredients||[]).join(', '))}</div>`; recipesContainer.appendChild(d);
    }); }
    renderRecipes(RECIPES);

    // add recipe button asks for day+slot
    window.addRecipeToSlot = function(btn){ const id = Number(btn.dataset.id); const r = RECIPES.find(x=>x.id===id); if(!r) return;
      const date = prompt('Fecha para añadir (YYYY-MM-DD):', todayStr); if(!date) return; ensureDay(date);
      const part = prompt('Turno (breakfast, lunch, dinner, snack):','lunch')||'lunch'; if(!['breakfast','lunch','dinner','snack'].includes(part)) return alert('Turno inválido');
      state.meals[date][part].push({name:r.name,ingredients:r.ingredients.join(', '),calories:r.cal,protein:r.protein,carbs:r.carbs,fat:r.fat,fromRecipe:true}); saveState(); renderMeals(date);
    }

    // export/import/reset
    document.getElementById('btnExport').addEventListener('click', ()=>{ const data = JSON.stringify(state,null,2); const blob = new Blob([data],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='nutriplan-data.json'; a.click(); URL.revokeObjectURL(url); });
    document.getElementById('btnImport').addEventListener('click', ()=>{ const input = document.createElement('input'); input.type='file'; input.accept='application/json'; input.onchange = e => { const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ev=>{ try{ const parsed = JSON.parse(ev.target.result); state = parsed; saveState(); renderMeals(todayStr); renderWeekTable(); alert('Importado con éxito'); }catch(err){ alert('Error al importar: archivo inválido') } }; reader.readAsText(f); }; input.click(); });
    document.getElementById('btnReset').addEventListener('click', ()=>{ if(!confirm('¿Eliminar todos los datos guardados localmente?')) return; state = {meals:{}}; saveState(); renderMeals(todayStr); renderWeekTable(); });

    // PLANIFICADOR SEMANAL --------------------------------------------------
    function getWeekDates(reference){ const ref = new Date(reference); // return Mon-Sun
      const dayIdx = ref.getDay(); // 0 Sun
      const monday = new Date(ref); monday.setDate(ref.getDate() - ((dayIdx+6)%7)); // monday
      const arr = []; for(let i=0;i<7;i++){ const d = new Date(monday); d.setDate(monday.getDate()+i); arr.push(d.toISOString().slice(0,10)); } return arr;
    }

    // Choose best combination (1-3 items) from RECIPES to match targets by minimizing weighted absolute error
    function bestCombinationForTargets(targetCal, targetP, targetC, targetF){
      let best = {score: Infinity, combo: []};
      const n = RECIPES.length;
      // allow single, pairs, triples (no repetition)
      for(let i=0;i<n;i++){
        const a = RECIPES[i];
        evaluateCombo([a]);
        for(let j=0;j<n;j++){
          const b = RECIPES[j];
          evaluateCombo([a,b]);
          for(let k=0;k<n;k++){
            const c = RECIPES[k];
            evaluateCombo([a,b,c]);
          }
        }
      }
      function evaluateCombo(arr){
        const sum = arr.reduce((s,x)=>({cal:s.cal+x.cal, p:s.p+x.protein, c:s.c+x.carbs, f:s.f+x.fat}),{cal:0,p:0,c:0,f:0});
        // weighted error: calories + protein*3 + carbs*1.2 + fat*2
        const errCal = Math.abs(targetCal - sum.cal);
        const errP = Math.abs(targetP - sum.p);
        const errC = Math.abs(targetC - sum.c);
        const errF = Math.abs(targetF - sum.f);
        const score = errCal + errP*3 + errC*1.2 + errF*2 + Math.max(0, sum.cal - targetCal)*0.5; // penaliza pasar mucho la caloría
        if(score < best.score){ best.score = score; best.combo = arr.slice(); }
      }
      return best.combo.map(r=>({name:r.name,ingredients:r.ingredients.join(', '),calories:r.cal,protein:r.protein,carbs:r.carbs,fat:r.fat}));
    }

    function generateWeeklyPlan(){
      const goal = Number(document.getElementById('goalCalories').value||2000);
      const gP = Number(document.getElementById('goalProtein').value||100);
      const gC = Number(document.getElementById('goalCarbs').value||200);
      const gF = Number(document.getElementById('goalFat').value||60);
      const splits = {
        breakfast: Number(document.getElementById('splitBreakfast').value||25)/100,
        lunch: Number(document.getElementById('splitLunch').value||30)/100,
        dinner: Number(document.getElementById('splitDinner').value||30)/100,
        snack: Number(document.getElementById('splitSnack').value||15)/100,
      };
      // normalize if sum !=1
      const sumSplits = Object.values(splits).reduce((a,b)=>a+b,0); for(const k in splits) splits[k]=splits[k]/sumSplits;
      const week = getWeekDates(todayStr);
      const plan = {};
      week.forEach(date=>{
        plan[date] = {breakfast:[], lunch:[], dinner:[], snack:[]};
        for(const part of Object.keys(splits)){
          const targetCal = Math.round(goal * splits[part]);
          const targetP = Math.round(gP * splits[part]);
          const targetC = Math.round(gC * splits[part]);
          const targetF = Math.round(gF * splits[part]);
          // use combinatorial search (1-3 items) to find best match
          const best = bestCombinationForTargets(targetCal, targetP, targetC, targetF);
          plan[date][part] = best;
        }
      });
      return plan;
    }

    document.getElementById('btnGenerateWeek').addEventListener('click', ()=>{
      const plan = generateWeeklyPlan(); const out = document.getElementById('weekResult'); out.innerHTML='';
      for(const date in plan){ out.innerHTML += `<div style="margin-bottom:8px"><strong>${date}</strong><div class="small muted">` + Object.keys(plan[date]).map(p=>`${p}: ${plan[date][p].map(x=>x.name).join(' | ')||'—'}`).join('<br>') + `</div></div>` }
      renderWeekPreview(plan);
    });

    // apply plan to state (adds meals to state and saves)
    document.getElementById('btnApplyWeek').addEventListener('click', ()=>{
      const plan = generateWeeklyPlan(); for(const date in plan){ ensureDay(date); for(const part of Object.keys(plan[date])){ state.meals[date][part] = state.meals[date][part].concat(plan[date][part]); } }
      saveState(); renderWeekTable(); renderMeals(todayStr); alert('Plan semanal aplicado al calendario.');
    });

    document.getElementById('btnClearWeek').addEventListener('click', ()=>{ if(!confirm('¿Limpiar las comidas de la semana actual?')) return; const week = getWeekDates(todayStr); week.forEach(d=>{ delete state.meals[d]; }); saveState(); renderWeekTable(); renderMeals(todayStr); });

    // render week preview table
    function renderWeekPreview(plan){ const container = document.getElementById('weekResult'); container.scrollTop=0; }

    function renderWeekTable(){ const container = document.getElementById('weekTable'); const week = getWeekDates(todayStr);
      let html = '<table><thead><tr><th>Fecha</th><th>Desayuno</th><th>Almuerzo</th><th>Cena</th><th>Snack</th></tr></thead><tbody>';
      week.forEach(date=>{ ensureDay(date); const p = state.meals[date]; const cell = k => p[k].map(x=>`${escapeHtml(x.name)} (${x.calories} kcal)`).join('<br>')||'<span class="small muted">—</span>';
        html += `<tr><td>${date}</td><td>${cell('breakfast')}</td><td>${cell('lunch')}</td><td>${cell('dinner')}</td><td>${cell('snack')}</td></tr>`;
      }); html += '</tbody></table>'; container.innerHTML = html;
    }

    // initial render
    renderMeals(todayStr); renderWeekTable();

    // helper: update summary for today
    function updateSummary(dateStr){ const t = totalsForDate(dateStr); document.getElementById('sumCalories').textContent = t.cal + ' kcal'; document.getElementById('sumProtein').textContent = t.p + ' g'; document.getElementById('sumCarbs').textContent = t.c + ' g'; document.getElementById('sumFat').textContent = t.f + ' g'; const goal = Number(document.getElementById('goalCalories').value || 2000); const pct = Math.min(100, Math.round((t.cal/goal)*100)); document.getElementById('progressCalories').style.width = pct + '%'; }

    // prevent console errors for file://
    window.addEventListener('load', ()=>{});
  </script>
</body>
</html>
